# Zawansowane Języki Programowania, 17/18

:experimental:
:imagesdir: ./images
:source-highlighter: pygments
:pygments-style: github
:icons: font

Literatura

. Greg Young, https://vimeo.com/108441214/description?__s=jvsvsq3unktoidfpqwzm[The art of destroying software], Vimeo
. Refactoring https://martinfowler.com/books/refactoringRubyEd.html[Ruby Edition],
  https://martinfowler.com/books/refactoring.html[Java Edition]
. http://helion.pl/ksiazki/czysty-kod-podrecznik-dobrego-programisty-robert-c-martin,czykov.htm#format/e[Czysty kod. Podręcznik dobrego programisty] (ebook)

Narzędzia

. Linters
. Code smell detectors (and brothers & sisters)
.. https://github.com/troessner/reek[reek] (for Ruby language)
.. https://github.com/bbatsov/rubocop[rubocop] – static code analyzer & style guide
.. https://github.com/seattlerb/flay[Flay] – analyzes code for structural similarities
. Editors
.. https://atom.io[Atom]


## Object Oriented Design

The foundation of an object-oriented system is the *message*,
but the most visible organizational structure
in a a class-based OO language (Ruby) is the *class*.

[quote, S. Metz, Practical Object Oriented Design in Ruby]
____
If your application succeeds many of the decisions you
make today will need to be changed later. […] +
Design is more the art of *preserving changeability*
than it is the act of achieving perfection.
____

{nbsp}

So, how to create classes to allow for easy changes?

// The classes we create will affect how we think about your application *forever*.


### The BDD micro-process

[quote]
____
You will never know less than you know right now.
____

|===
| RED        | Write a new test and see it fail.
| GREEN      | Get all tests passing, using the most naive approach you can see.
| *REFACTOR* | Transition to the simplest design that passes the current tests,
               by removing any introduced smells.
| _repeat_   |
|===

[caption=""]
.A quantum point of view on programming
image::bdd_mini.jpg[A quantum point of view on programming, 600, 600]

Programmer State Attention Exclusion Principle:: A programmer
attentions should not occupy different states simultaneously.


## Refactor

Refactoring to technika bezpiecznego udoskonalania *istniejącego kodu*.
Innymi słowami, w trakcie refactoringu poprawiamy kod udoskonalając jego
wewnętrzną strukturę i nie zmieniając jego działania.

W trakcie refactoringu zmienia się nasze rozumienie cudzego kodu
Dlatego kod po refactoringu jest łatwiejszy w zrozumieniu
i łatwiej go rozszerzać (szybciej piszemy nowy kod i robimy mniej błędów).


### A refactoring example – _Hide Delegate_

Refactorings are designed to be safe transformations.
But mistakes happens. So, use version control.

.hide_delegate.rb
```ruby
class Rectangle
  attr_reader :top_left, :width, :height

  def initialize top_left, width, height
    @top_left = top_left
    @width = width
    @height = height
  end
end

class Point
  attr_reader :x, :y

  def initialize x, y
    @x = x
    @y = y
  end
end
```

To find the _x_-coordinate of a rectangle’s left coordinate we have to use:

```ruby
rect = Rectangle.new Point.new(4, 5), 3, 2
left_x = rect.top_left.x
```

and wy may want to hide this delegation.

The suggested steps for _Hide Delegate_ are following:

1. Create a delegating method on the `Rectangle` class. *Test*.
2. For each client of the delegate adjust it to call the new method. *Test*.
3. If no client needs to access the delegate any longer
  remove the `Rectangle` accessor for the delegate. *Test*.

.Step 1
```ruby
class Rectangle
  def left_edge
    @top_left.x
  end
end
```

.Step 2
```ruby
left_x = rect.left_edge
```

.Step 3
```ruby
class Rectangle
  attr_reader :width, :height
end
```


## Code smells ➨ Refactor

Code smells suggest refactorings.

[cols=">10s,25,65", options="header", caption=""]
.Code Smells, Refactoring in Ruby by W. C. Wake & K. Rutherford
|===
^| # ^| Code Smell   ^| Refactorings

| 2+^e| Accommodating Change
| 2+^e| Conditional Logic
| 2+^e| Data
| 2+^e| Duplication
|     | Dervived Value  |
|     | Duplicated Code |
| 2+^e| Inheritance
|     | Repeated Value  |
| 2+^e| Libraries
| 2+^e| Measurable Smells
| 2+^e| Names
|     | Inconsistent Name    | j.w.
|     | Type Embeded in Name | Rename Method (or constant etc.)
|     | Uncommunicative Name | j.w.
| 2+^e| Responsibility
|   1 | Feature Envy           | Extract Method, Move Method, see Utility Function
|   2 | Global Variable        | Add Parameter
|     | Greedy Module          |
|     | Inappropriate Intimacy |
|     | Message Chain          |
|     | Middle Man             |
|   2 | Utility Function       | Extract Class
| 2+^e| Unnecessary Complexity
|===

NOTE: Probably, these refactorings are responsible for fixing the most
smells: Move Method, Extract Class, Move Field, Extract Method

WARNING: Quite a few refactorings are not mentioned by any
of the smells.


## The refactoring cycle

.Source: Refactoring in Ruby by W. C. Wake & K. Rutherford
[verse]
start with working (tested) code
while the design can be simplified
  choose the worst smell
  select a refactoring that will address the smell
  apply the refactoring
  (check that tests still pass)


IMPORTANT: This approach to refactoring does not guarantee to
get the ideal design, because you can not reach a global
maximum by looking at local properties.


## Automatyczne wyszukiwanie code smells w kodzie

Przykład automatycznego wyszukiwania code smells w pliku
za pomocą programu _reek_ –
https://github.com/troessner/reek[Code smell detector for Ruby].

.smelly.rb
[source,ruby]
----
# Smelly class
class Smelly
  # This will reek of UncommunicativeMethodName
  def x
    y = 10 # This will reek of UncommunicativeVariableName
  end
end
----

```sh
reek smelly.rb
Inspecting 1 file(s):
S

smelly.rb -- 2 warnings:
  [4]:UncommunicativeMethodName: Smelly#x has the name 'x' [https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Method-Name.md]
  [5]:UncommunicativeVariableName: Smelly#x has the variable name 'y' [https://github.com/troessner/reek/blob/master/docs/Uncommunicative-Variable-Name.md]
```

### Exercises to try – Smell of the Week

Więcej przykładowych programów do wybróbowania z programem _reek_ można
znależć na http://www.codequizzes.com/ruby[Learn Ruby].

Można też spróbować swoich sił na zadaniach z portalu http://exercism.io[Exercism].

```sh
exercism list ruby
exercism fetch ruby hello-world
```
